package seentao.xhsn.common;

import java.lang.reflect.Method;
import java.sql.Timestamp;
import java.util.Calendar;
import java.util.Iterator;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;
import org.springframework.web.context.WebApplicationContext;

import seentao.xhsn.bean.HsTaskBO;
import seentao.xhsn.sys.seentaotask.dao.ISeenTaoTaskDAO;

/**
 * 定时执行的任务
 * 
 * @author niushixing 2015-1-19 15:38:50
 *
 */
@Controller
@Scope(BeanDefinition.SCOPE_SINGLETON)
public class SeenTaoQuartzTask {
	@Autowired
	private WebApplicationContext ctx;

	@Autowired
	private ISeenTaoTaskDAO taskDao;

	// 执行任务方法
	public synchronized void execute() {
		try {
			Timestamp timeNow = new Timestamp(System.currentTimeMillis());
			Iterator<HsTaskBO> iter = ResourcesConstants.ARRAY_TASK.iterator();
			// 遍历task列表
			while (iter.hasNext()) {
				HsTaskBO task = iter.next();
				Timestamp exeTime = task.getExecuteTime();
				if (exeTime.before(timeNow)) {
					Object o = ctx.getBean(task.getExecutor());
					Class<? extends Object> c = o.getClass();
					Method m = c.getDeclaredMethod(task.getMethod(), String[].class);
					String param = task.getParameters();
					String[] params = null;
					if (param != null && !param.equals("")) {
						params = param.split(",");
					}
					m.invoke(o, params);
					// 更新列表
					if (task.getTaskType().equals(ResourcesConstants.TASK_ONETIME)) {
						iter.remove();
						taskDao.update(task);
					} else if (task.getTaskType().equals(ResourcesConstants.TASK_EVERYDAY)) {
						Calendar x = Calendar.getInstance();
						x.setTime(task.getExecuteTime());
						x.add(Calendar.DATE, 1);
						task.setExecuteTime(new Timestamp(x.getTimeInMillis()));
						taskDao.update(task);
					} else if (task.getTaskType().equals(ResourcesConstants.TASK_EVERYWEEK)) {
						Calendar x = Calendar.getInstance();
						x.setTime(task.getExecuteTime());
						x.add(Calendar.WEEK_OF_MONTH, 1);
						task.setExecuteTime(new Timestamp(x.getTimeInMillis()));
						taskDao.update(task);
					} else if (task.getTaskType().equals(ResourcesConstants.TASK_EVERYMONTH)) {
						Calendar x = Calendar.getInstance();
						x.setTime(task.getExecuteTime());
						x.add(Calendar.MONTH, 1);
						task.setExecuteTime(new Timestamp(x.getTimeInMillis()));
						taskDao.update(task);
					} else if (task.getTaskType().equals(ResourcesConstants.TASK_EVERYYEAR)) {
						Calendar x = Calendar.getInstance();
						x.setTime(task.getExecuteTime());
						x.add(Calendar.YEAR, 1);
						task.setExecuteTime(new Timestamp(x.getTimeInMillis()));
						taskDao.update(task);
					}
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	public String addTask() {

		return "";
	}

	public String removeTask() {

		return "";
	}

	/**
	 * 更新任务
	 * 
	 * @param task
	 * @return
	 */
	public String updateTask(HsTaskBO task) {

		return "";
	}
}
