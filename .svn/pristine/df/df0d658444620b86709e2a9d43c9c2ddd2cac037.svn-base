package seentao.xhsn.person.home.action;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import seentao.xhsn.bean.HsEtpReleasejobBO;
import seentao.xhsn.common.DictionaryEnum;
import seentao.xhsn.common.ResourcesConstants;
import seentao.xhsn.common.SeentaoApplicationContext;
import seentao.xhsn.common.UserSessionBean;
import seentao.xhsn.enterprise.releasejob.service.IReleasejobService;
import seentao.xhsn.person.home.service.IHomePageService;
import seentao.xhsn.person.jobsearch.bean.JobDetailBean;
import seentao.xhsn.person.jobsearch.service.IJobSearchService;
import seentao.xhsn.tools.Page;

import com.opensymphony.xwork2.ActionSupport;

/** 
 * @author wjx 
 * @date 2015年1月5日 下午3:48:42 
 * @note 首页action
 */
@Controller
@Scope("prototype")
public class HomePageAction extends ActionSupport {
	private static final long serialVersionUID = -6017372539507169642L;
	// 搜索到的职位
	private List<JobDetailBean> jobs ;
	private Page<HsEtpReleasejobBO> page;
	private String cityCode;
	private String city_text;
	private String trade_text;
	private String job_text;
	private HsEtpReleasejobBO bo;
	
	@Autowired
	private IHomePageService homePageService;
	@Autowired
	private IJobSearchService jobSearchService;
	/**
	 * 首页跳转
	 * @return
	 */
	public String goHomePage(){
		HsEtpReleasejobBO bo = new HsEtpReleasejobBO();
		bo.setRel_status(IReleasejobService.STATUS_PUBLISHED);
		bo.setCounty_code(null);
		bo.setCounty_code_list(null);
		Map<String, Object> params = new HashMap<String, Object>();
		params.put("bo", bo);
		page = new Page<HsEtpReleasejobBO>();
		page.setPageSize(8);
		page.setParams(params );
		jobs = homePageService.findAllJobByCityCode(page);
		return "SUCCESS";
	}
	
	public String findJobByPage(){
		HsEtpReleasejobBO bo = new HsEtpReleasejobBO();
		bo.setCounty_code_list(Arrays.asList(cityCode.split(",")));
		bo.setCounty_code(cityCode);
		bo.setRel_status(IReleasejobService.STATUS_PUBLISHED);
		
		List<String>  county_code_list = bo.getCounty_code_list();
		if(county_code_list != null && county_code_list.size() > 0){
			int index = county_code_list.indexOf(DictionaryEnum.OTHER_DATA.getStringValue());
			if(index >= 0){
				bo.setCounty_code(null);
				bo.setCounty_code_list(null);
			}
		}
		Map<String, Object> params = new HashMap<String, Object>();
		params.put("bo", bo);
		page.setParams(params );
		jobs = homePageService.findAllJobByCityCode(page);
		return "SUCCESS";
	}
	
	public String goSearchJob(){
		UserSessionBean bean = (UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY);
		String user_id = bean.getUser_sys_id();
		if(page == null ){
			page = new Page<HsEtpReleasejobBO>();
		}
			Map<String, Object> params = new HashMap<String, Object>();
			if(bo.getJob_id() != null && bo.getJob_id().trim().length() > 0){
				bo.setJob_id_list(Arrays.asList(bo.getJob_id().split(",")));
			}
			if(bo.getTrade_id() != null && bo.getTrade_id().trim().length() > 0){
				bo.setTrade_id_list(Arrays.asList(bo.getTrade_id().split(",")));
			}
			if(bo.getCounty_code() != null && bo.getCounty_code().trim().length() > 0){
				bo.setCounty_code_list(Arrays.asList(bo.getCounty_code().split(",")));
			}
			bo.setRel_status(IReleasejobService.STATUS_PUBLISHED);
			//1、保存搜索的相关信息
			jobSearchService.insert(user_id, bo);
			//2、根据条件查询所有的相关信息
			//如果行业中包含不限，就清除该条件
			List<String> trade_id_list = bo.getTrade_id_list();
			if(trade_id_list != null && trade_id_list.size() > 0){
				int index = trade_id_list.indexOf(DictionaryEnum.OTHER_DATA.getStringValue());
				if(index >= 0){
					bo.setTrade_id(null);
					bo.setTrade_id_list(null);
				}
			}
			//如果工作地点中包含不限，就清除该条件
			List<String>  county_code_list = bo.getCounty_code_list();
			if(county_code_list != null && county_code_list.size() > 0){
				int index = county_code_list.indexOf(DictionaryEnum.OTHER_DATA.getStringValue());
				if(index >= 0){
					bo.setCounty_code(null);
					bo.setCounty_code_list(null);
				}
			}
			params.put("bo", bo);
			page.setParams(params );
			jobs = jobSearchService.searchAllByParam(page);
		
		return "SUCCESS";
	}
	
	public List<JobDetailBean> getJobs() {
		return jobs;
	}

	public void setJobs(List<JobDetailBean> jobs) {
		this.jobs = jobs;
	}

	public Page<HsEtpReleasejobBO> getPage() {
		return page;
	}

	public void setPage(Page<HsEtpReleasejobBO> page) {
		this.page = page;
	}

	public String getCityCode() {
		return cityCode;
	}

	public void setCityCode(String cityCode) {
		this.cityCode = cityCode;
	}

	public HsEtpReleasejobBO getBo() {
		return bo;
	}

	public void setBo(HsEtpReleasejobBO bo) {
		this.bo = bo;
	}

	public String getCity_text() {
		return city_text;
	}

	public void setCity_text(String city_text) {
		this.city_text = city_text;
	}

	public String getTrade_text() {
		return trade_text;
	}

	public void setTrade_text(String trade_text) {
		this.trade_text = trade_text;
	}

	public String getJob_text() {
		return job_text;
	}

	public void setJob_text(String job_text) {
		this.job_text = job_text;
	}

	
	
	
}
