package seentao.xhsn.sys.enterpriseupload.service.impl;

import java.sql.Timestamp;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import seentao.xhsn.bean.HsEnterpriseBO;
import seentao.xhsn.bean.HsEtpReleasejobBO;
import seentao.xhsn.bean.HsUserBO;
import seentao.xhsn.common.DictionaryEnum;
import seentao.xhsn.common.ResourcesConstants;
import seentao.xhsn.enterprise.info.dao.IInfoDAO;
import seentao.xhsn.enterprise.releasejob.dao.IReleasejobDAO;
import seentao.xhsn.login.util.PassWordUtil;
import seentao.xhsn.regist.dao.IRegistDao;
import seentao.xhsn.sys.enterpriseupload.service.IEnterpriseUploadService;

@Service
@Transactional
public class EnterpriseUploadServiceImpl implements IEnterpriseUploadService {
	
	@Autowired
	private IInfoDAO infoDAO;
	@Autowired
	private IRegistDao registDao;
	@Autowired
	private IReleasejobDAO rjDao;
	
	@Override
	public void save(Map<String, HsEnterpriseBO> enterMap,
			Map<String, List<HsEtpReleasejobBO>> releasejobMap) {
		Set<Entry<String, HsEnterpriseBO>> set = enterMap.entrySet();
		Iterator<Entry<String, HsEnterpriseBO>> it = set.iterator();
		HsUserBO userBO=new HsUserBO();
		while(it.hasNext()){
			Entry<String, HsEnterpriseBO> bo = it.next();
			String mail = bo.getKey();
			//判断该邮箱是否已注册
			 userBO=new HsUserBO();
			 userBO.setUser_email(mail);
			 userBO.setUser_type(Integer.valueOf(DictionaryEnum.ENTERPRISE_TYPE.getStringValue()));
			 List<HsUserBO> list=registDao.findUserByParam(userBO);
			 if(list!=null&&list.size()>0){
				 HsEnterpriseBO enterpriseBO = infoDAO.getBySysUserId(list.get(0).getId());
				//新职位信息
				 List<HsEtpReleasejobBO> releasejobList = releasejobMap.get(mail);
				 if(releasejobList!=null&&releasejobList.size()>0){
					 for(HsEtpReleasejobBO etpReleasejobBO:releasejobList){
						 etpReleasejobBO.setCom_id(enterpriseBO.getId());
						 rjDao.insert(etpReleasejobBO);
					 }
				 }
			 }else{
				 userBO.setUser_isopen(DictionaryEnum.MAIL_OPEN.getIntValue());
				 userBO.setUser_pwd(PassWordUtil.createPassword("000000"));
				 userBO.setUser_registtime(new Timestamp(System.currentTimeMillis()));
				 userBO.setUser_state(DictionaryEnum.STATE_NORMAL.getStringValue());
				 
				 userBO.setUser_loginnum(0);
				 //注册信息
				 String sysID= registDao.insert(userBO);
				 //基本信息
				 HsEnterpriseBO enterpriseBO = bo.getValue();
				 enterpriseBO.setSys_user_id(sysID);
				 String comID=infoDAO.insert(enterpriseBO);
				 //新职位信息
				 List<HsEtpReleasejobBO> releasejobList = releasejobMap.get(mail);
				 if(releasejobList!=null&&releasejobList.size()>0){
					 for(HsEtpReleasejobBO etpReleasejobBO:releasejobList){
						 etpReleasejobBO.setCom_id(comID);
						 rjDao.insert(etpReleasejobBO);
					 }
				 }
			 }
		}
	}

	
}
