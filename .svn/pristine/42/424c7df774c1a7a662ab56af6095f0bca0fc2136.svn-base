package seentao.xhsn.enterprise.info.action;

import java.io.File;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import net.sf.json.JSONObject;

import org.apache.struts2.ServletActionContext;
import org.apache.struts2.json.annotations.JSON;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import seentao.xhsn.bean.HsDictionaryDataBO;
import seentao.xhsn.bean.HsEnterpriseBO;
import seentao.xhsn.common.ResourcesConstants;
import seentao.xhsn.common.SeentaoApplicationContext;
import seentao.xhsn.common.UserSessionBean;
import seentao.xhsn.enterprise.info.service.IEnterpriseService;
import seentao.xhsn.sys.dictionaryfiledmap.service.IDictionaryFieldMapService;

import com.opensymphony.xwork2.ActionSupport;

/**
 * 公司基本信息Action
 * 
 * @author niushixing 2014-12-8 下午4:36:44
 * 
 */
@Controller
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
public class InfoAction extends ActionSupport {
	private static final long serialVersionUID = 4669396926647650639L;
	private String id;
	private HsEnterpriseBO bo;
	private String type;
	private String result;
	@Autowired
	private IDictionaryFieldMapService dfmService;
	@Autowired
	private IEnterpriseService enterpriseService;

	private Map<String, List<HsDictionaryDataBO>> mapDic;

	private List<HsDictionaryDataBO> comsizelist;

	/**
	 * 页面初始化
	 * 
	 * @return
	 */
	public String init() {
		if (null == id || id.equals("")) {
			id = ((UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY))
					.getUser_id();
		}
		bo = enterpriseService.getByPK(id);
		if (null == bo) {
			return ERROR;
		}
		if (null != bo.getSize_id()) {
			String com_size = dfmService.getDictValueByParam("hs_enterprise", "size_id", bo.getSize_id()).get("value");
			// String trade_name =
			// dfmService.getDictValueByParam("hs_enterprise",
			// "size_id", bo.getSize_id()).get("value");
			bo.setCom_size(com_size);
		}
		// 如果没有填写公司资料，跳转到填写页面
		if (null == type || "".equals(type) || "show".equals(type)) {
			if (bo.getTrade_code() == null || bo.getTrade_code().equals("")) {
				type = "edit";
			}
		}

		if (null == type || "".equals(type) || "show".equals(type)) {
			HttpServletRequest request = ServletActionContext.getRequest();
//			String path = request.getContextPath();
			String basePath = request.getScheme() + "://" + request.getServerName() + ":" + request.getServerPort()
					+ ResourcesConstants.FILESYS_CONTEXT;
			if (bo.getLogo_path() != null && bo.getLogo_path() != "") {
				bo.setLogo_path(basePath + bo.getLogo_path());
			}
			return SUCCESS;
		} else if ("edit".equals(type)) {
			mapDic = dfmService.findDictDataByParam("hs_enterprise");
			if (null != mapDic && mapDic.size() > 0) {
				comsizelist = mapDic.get("company_size");
			}
			return INPUT;
		}
		return ERROR;
	}

	/**
	 * 更新编辑的公司信息
	 * 
	 * @return
	 */
	public String update() {
		((UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY)).setPhoto_url(bo
				.getLogo_path());
		enterpriseService.update(bo);
		result = "OK";
		return SUCCESS;
	}

	private File file;
	private String fileName;
	private String fileFileName;

	/**
	 * 上传企业logo
	 * 
	 * @return
	 */
	public String entLogoUpload() throws Exception {
		HttpServletResponse response = ServletActionContext.getResponse();
		response.setCharacterEncoding("utf-8");
		if (file != null && file.length() > 0) {
			long size = file.length();
			if (size > 512000) {
				response.getWriter().print("{\"error\":\"error\"}");
			} else {
				fileName = enterpriseService.uploadLogo(file, fileFileName);
				JSONObject obj = new JSONObject();
				obj.put("path", fileName);
				String json = obj.toString();
				response.getWriter().print(json);
			}
		}

		return null;
	}

	public String getId() {
		return id;
	}

	public void setId(String id) {
		this.id = id;
	}

	@JSON(serialize = false)
	public HsEnterpriseBO getBo() {
		return bo;
	}

	public void setBo(HsEnterpriseBO bo) {
		this.bo = bo;
	}

	public String getType() {
		return type;
	}

	public void setType(String type) {
		this.type = type;
	}

	@JSON(serialize = false)
	public List<HsDictionaryDataBO> getComsizelist() {
		return comsizelist;
	}

	public void setComsizelist(List<HsDictionaryDataBO> comsizelist) {
		this.comsizelist = comsizelist;
	}

	public String getResult() {
		return result;
	}

	public void setResult(String result) {
		this.result = result;
	}

	@JSON(serialize = false)
	public Map<String, List<HsDictionaryDataBO>> getMapDic() {
		return mapDic;
	}

	public void setMapDic(Map<String, List<HsDictionaryDataBO>> mapDic) {
		this.mapDic = mapDic;
	}

	@JSON(serialize = false)
	public File getFile() {
		return file;
	}

	public void setFile(File file) {
		this.file = file;
	}

	public String getFileName() {
		return fileName;
	}

	public void setFileName(String fileName) {
		this.fileName = fileName;
	}

	public String getFileFileName() {
		return fileFileName;
	}

	public void setFileFileName(String fileFileName) {
		this.fileFileName = fileFileName;
	}
}
