package seentao.xhsn.enterprise.resumesearch.service.impl;

import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Iterator;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import seentao.xhsn.bean.HsEtpFollowResumeBO;
import seentao.xhsn.common.ResourcesConstants;
import seentao.xhsn.common.SeentaoApplicationContext;
import seentao.xhsn.common.UserSessionBean;
import seentao.xhsn.enterprise.followresume.dao.IFollowResumeDAO;
import seentao.xhsn.enterprise.manageresume.bean.ManageResumeBean;
import seentao.xhsn.enterprise.resumesearch.bean.ResumeSearchBean;
import seentao.xhsn.enterprise.resumesearch.service.IResumeSearchService;
import seentao.xhsn.person.put.dao.IPutResumeDAO;
import seentao.xhsn.sys.dictionaryfiledmap.dao.IDictionaryFieldMapDao;
import seentao.xhsn.tools.ArrayBoUtil;
import seentao.xhsn.tools.Page;

/**
 * 
 * @author niushixing 2014-12-15 下午3:34:29
 * 
 */
@Service
public class ResumeSearchServiceImpl implements IResumeSearchService {
	@Autowired
	private IPutResumeDAO putDao;
	@Autowired
	private IDictionaryFieldMapDao dicDao;

	@Override
	public List<ManageResumeBean> getResumeSearchResult(Page<ResumeSearchBean> page) {
		List<ManageResumeBean> list = new ArrayList<ManageResumeBean>();
		list = putDao.getEntSearchResumeByPage(page);
		Iterator<ManageResumeBean> iter = list.iterator();
		SimpleDateFormat sf = new SimpleDateFormat("yyyy-MM-dd");
		while (iter.hasNext()) {
			ManageResumeBean bean = iter.next();
			bean.setGender(bean.getGender().equals("0") ? "男" : "女");
			bean.setAge(calculateAge(bean.getBirthday()) + "周岁");

			if (bean.getExp_year() != null) {
				String exp_year = dicDao.getDictByParam("hs_userbasicinfo", "job_exp_year", bean.getExp_year()).get(
						"value");
				bean.setExp_year(exp_year);
			}
			if (null != bean.getModify_time()) {
				try {
					bean.setDate(sf.format(sf.parse(bean.getModify_time())));
				} catch (ParseException e) {
					bean.setDate(null);
					continue;
				}
			}
			
			if(null!=bean.getJob_name()){
				bean.setJob_name(ArrayBoUtil.getJobByCode(bean.getJob_name()));
			}
			if(null!=bean.getAddress()){
				bean.setAddress(ArrayBoUtil.getCityByCode(bean.getAddress()));
			}
		}
		return list;
	}

	private String calculateAge(Timestamp date) {
		if (null == date)
			return "0";
		Calendar c1 = Calendar.getInstance();
		c1.setTime(date);
		Calendar c2 = Calendar.getInstance();
		int yearBirth = c1.get(Calendar.YEAR);
		int monthBirth = c1.get(Calendar.MONTH);
		int dayBirth = c1.get(Calendar.DATE);

		int yearNow = c2.get(Calendar.YEAR);
		int monthNow = c2.get(Calendar.MONTH);
		int dayNow = c2.get(Calendar.DATE);

		int age = yearNow - yearBirth;
		if (monthNow <= monthBirth) {
			if (monthNow == monthBirth) {
				if (dayNow < dayBirth) {
					age--;
				}
			} else {
				age--;
			}
		}
		return age + "";
	}

	@Autowired
	private IFollowResumeDAO followDao;

	@Override
	@Transactional
	public String followResume(String res_id) {
		if (null == res_id || res_id.equals(""))
			return "NONE";
		String etp_id = ((UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY))
				.getUser_id();
		HsEtpFollowResumeBO followbo = new HsEtpFollowResumeBO();
		followbo.setRes_id(res_id);
		followbo.setEtp_id(etp_id);
		followDao.insert(followbo);
		return "OK";
	}
}
