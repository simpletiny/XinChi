package seentao.xhsn.person.jobsearch.action;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import seentao.xhsn.bean.HsDesiredPositionBO;
import seentao.xhsn.bean.HsEtpReleasejobBO;
import seentao.xhsn.common.DictionaryEnum;
import seentao.xhsn.common.ResourcesConstants;
import seentao.xhsn.common.SeentaoApplicationContext;
import seentao.xhsn.common.UserSessionBean;
import seentao.xhsn.enterprise.releasejob.service.IReleasejobService;
import seentao.xhsn.person.desired.service.IDesiredPositionService;
import seentao.xhsn.person.jobsearch.bean.JobDetailBean;
import seentao.xhsn.person.jobsearch.service.IJobSearchService;
import seentao.xhsn.person.resume.service.IResumeService;
import seentao.xhsn.tools.Page;

import com.opensymphony.xwork2.ActionSupport;

/**
 * 职位搜索Action
 * 
 * @author niushixing 2014-12-2 上午10:31:22
 * 
 */
@Controller
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
public class JobSearchAction extends ActionSupport {
	private static final long serialVersionUID = -8694362010999242178L;
	
	// 企业投放的职位Id
	private String releaseJobId;
	private JobDetailBean jobDetail;
	private HsDesiredPositionBO desiredBO;
	private HsEtpReleasejobBO bo;
	private String res_id;
	// 搜索到的职位
	private List<JobDetailBean> result_jobs ;

	private Page<HsEtpReleasejobBO> page;
	@Autowired
	private IJobSearchService jobSearchService;
	
	@Autowired
	private IResumeService resumeService;
	
	@Autowired
	private IDesiredPositionService desiredService;
	
	/**
	 * 根据条件，进行搜索
	 * @return
	 */
	public String search(){
		
		String user_id = "";
		if(page != null && bo != null){
			Map<String, Object> params = new HashMap<String, Object>();
			if(bo.getJob_id() != null && bo.getJob_id().trim().length() > 0){
				bo.setJob_id_list(Arrays.asList(bo.getJob_id().split(",")));
			}
			if(bo.getTrade_id() != null && bo.getTrade_id().trim().length() > 0){
				bo.setTrade_id_list(Arrays.asList(bo.getTrade_id().split(",")));
			}
			if(bo.getCounty_code() != null && bo.getCounty_code().trim().length() > 0){
				bo.setCounty_code_list(Arrays.asList(bo.getCounty_code().split(",")));
			}
			bo.setRel_status(IReleasejobService.STATUS_PUBLISHED);
			//1、保存搜索的相关信息
			jobSearchService.insert(user_id, bo);
			//2、根据条件查询所有的相关信息
			//如果行业中包含不限，就清除该条件
			List<String> trade_id_list = bo.getTrade_id_list();
			if(trade_id_list != null && trade_id_list.size() > 0){
				int index = trade_id_list.indexOf(DictionaryEnum.OTHER_DATA.getStringValue());
				if(index >= 0){
					bo.setTrade_id(null);
					bo.setTrade_id_list(null);
				}
			}
			//如果工作地点中包含不限，就清除该条件
			List<String>  county_code_list = bo.getCounty_code_list();
			if(county_code_list != null && county_code_list.size() > 0){
				int index = county_code_list.indexOf(DictionaryEnum.OTHER_DATA.getStringValue());
				if(index >= 0){
					bo.setCounty_code(null);
					bo.setCounty_code_list(null);
				}
			}
			params.put("bo", bo);
			page.setParams(params );
			result_jobs = jobSearchService.searchAllByParam(page);
		}else{
			bo = new HsEtpReleasejobBO();
			page = new Page<HsEtpReleasejobBO>();
			Map<String, Object> params = new HashMap<String, Object>();
			params.put("bo", bo);
			page.setParams(params);
			result_jobs = jobSearchService.searchAllByParam(page);
		}
		/*UserSessionBean bean = (UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY);
		res_id = bean.getRes_id();
		res_id = ((UserSessionBean)SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY)).getRes_id();
		ServletContext context = ServletActionContext.getServletContext();
		HsResumeBO resumeBo = resumeService.getByPk("d3l-fXV-fHR4gH53eHtxcw");
		resumeService.generateResumeHTML(resumeBo, context);*/
		return "LIST";
	}
	
	/**
	 * 职位详情初始化
	 * 
	 * @return
	 */
	public String jobDetailInit() {
		jobDetail = jobSearchService.getJobDetail(releaseJobId);
		return SUCCESS;
	}
	
	
	/**
	 * 用户的求职意向进行查找
	 * @return
	 */
	public String searchByDesired(){
		
		/*String user_id = SeentaoApplicationContext.getCurrentUser();
		res_id = ((UserSessionBean)SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY)).getRes_id();
		*/
		UserSessionBean bean = (UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY);
		String user_id =bean.getUser_sys_id();
		String res_id = bean.getRes_id();
		if(desiredBO == null || desiredBO.getId() == null || desiredBO.getId().trim().length() <= 0){
			desiredBO = desiredService.getByUserIdAndResId(user_id, res_id);
		}
		result_jobs = jobSearchService.searchAllByDesired(page, desiredBO);
		return "LIST";
	}
	
	
	
	public String getReleaseJobId() {
		return releaseJobId;
	}

	public void setReleaseJobId(String releaseJobId) {
		this.releaseJobId = releaseJobId;
	}
	public JobDetailBean getJobDetail() {
		return jobDetail;
	}
	public void setJobDetail(JobDetailBean jobDetail) {
		this.jobDetail = jobDetail;
	}

	public List<JobDetailBean> getResult_jobs() {
		return result_jobs;
	}

	public void setResult_jobs(List<JobDetailBean> result_jobs) {
		this.result_jobs = result_jobs;
	}

	public HsEtpReleasejobBO getBo() {
		return bo;
	}

	public void setBo(HsEtpReleasejobBO bo) {
		this.bo = bo;
	}

	public Page<HsEtpReleasejobBO> getPage() {
		return page;
	}

	public void setPage(Page<HsEtpReleasejobBO> page) {
		this.page = page;
	}

	public String getRes_id() {
		return res_id;
	}

	public void setRes_id(String res_id) {
		this.res_id = res_id;
	}

	public HsDesiredPositionBO getDesiredBO() {
		return desiredBO;
	}

	public void setDesiredBO(HsDesiredPositionBO desiredBO) {
		this.desiredBO = desiredBO;
	}
	
}
