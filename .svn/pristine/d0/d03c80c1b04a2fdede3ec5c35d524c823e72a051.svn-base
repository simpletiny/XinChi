$(document).ready(function() {

});

function addCity() {
	$("#div_add_city").is(":visible") ? (function() {
		$("#div_add_city").slideUp();
	}()) : (function() {
		provinceCode = $("#select_add_province").val();
		$("#txt_city_code").val(provinceCode.substring(0, 2));
		$("#div_add_city").slideDown();
	}());

}
function validate() {
	if ($.trim($("#txt_city_name").val()) == "") {
		alert("名称不能为空！");
		return false;
	}
	if ($.trim($("#txt_city_code").val()) == "") {
		alert("编码不能为空！");
		return false;
	}
	if ($.trim($("#txt_city_code").val()).length != 4) {
		alert("编码必须为4位！")
		return false;
	}
	var province_code = $("#select_add_province").val();
	var code = province_code.substring(0, 2);
	if (code != $.trim($("#txt_city_code").val()).substring(0, 2)) {
		alert("编码必须以" + code + "开头！")
		return false;
	}
	if ($.trim($("#txt_sort_no").val()) == "") {
		alert("排序号不能为空！");
		return false;
	}
	return true;
}
/**
 * 保存添加的城市
 */
function saveCity() {
	if (!validate())
		return;
	var param = $("#form_add_city").serialize();
	$.ajax({
		url : "saveCity",
		data : param,
		type : 'post',
		success : function(r) {
			if (r == "OK") {
				refreshCityArray();
				$("#div_add_city").slideUp();
				changeProvince();
				alert("保存成功!");
			} else if (r == "NAME") {
				alert("城市名称已经存在");
			} else if (r == "CODE") {
				alert("城市编码已经存在");
			}
		}
	});
}
/**
 * 编辑城市
 */
function editCity(span) {
	var txt1 = $("<input class='txt1' type='text' style='width:100px' maxlength='50'/>");
	// var txt2 = $("<input class='txt2' type='text' style='width:50px'
	// maxlength='4'/>");
	var txt3 = $("<input class='txt3' type='text' style='width:50px' maxlength='4'/>");

	var tr = $(span).parents("tr:first");
	var td1 = tr.find("td.tdName");
	// var td2 = tr.find("td.tdCode");
	var td3 = tr.find("td.tdSort");
	var td4 = tr.find("td.tdOperate");

	txt1.val($.trim(td1.html()));
	// txt2.val($.trim(td2.html()));
	txt3.val($.trim(td3.html()));
	td1.html(txt1);
	// td2.html(txt2);
	td3.html(txt3);
	txt1.focus();

	td4
			.html("<span style='cursor:pointer;color:blue' onclick='updateCity(this)'>保存</span>")
}

function updateCity(span) {
	var tr = $(span).parents("tr:first");
	var cityName = tr.find("input.txt1").val();
	// var cityCode = tr.find("input.txt2").val();
	var sortNo = tr.find("input.txt3").val();
	var cityId = tr.find("input.txtCityId").val();

	if ($.trim(cityName) == "") {
		alert("名称不能为空！");
		return false;
	}
	// if ($.trim(cityCode) == "") {
	// alert("编码不能为空！");
	// return false;
	// }
	// if ($.trim(cityCode).length != 4) {
	// alert("编码必须为4位！")
	// return false;
	// }
	// var province_code = $("#select_province").val();
	// var code = province_code.substring(0, 2);
	// if (code != $.trim(cityCode).substring(0, 2)) {
	// alert("编码必须以" + code + "开头！")
	// return false;
	// }
	if ($.trim(sortNo) == "") {
		alert("排序号不能为空！");
		return false;
	}

	var param = "cityBo.city_name=" + cityName;
	// param += "&cityBo.city_code=" + cityCode;
	param += "&cityBo.sort_no=" + sortNo;
	param += "&cityBo.id=" + cityId;
	$.ajax({
		url : "saveCity",
		data : param,
		type : 'post',
		success : function(r) {
			if (r == "OK") {
				refreshCityArray();
				changeProvince();
				alert("修改成功!");
			} else if (r == "NAME") {
				alert("城市名称已经存在");
			} else if (r == "CODE") {
				alert("城市编码已经存在");
			}
		}
	});
}
/**
 * 删除城市
 */
function deleteCity(span) {
	var city_id = $(span).parents("tr:first").find("input.txtCityId:first")
			.val();
	if (confirm("确认要删除当前城市吗？删除后无法恢复！")) {
		var param = "city_id=" + city_id;
		$.ajax({
			url : "deleteCity",
			data : param,
			type : 'get',
			success : function(r) {
				if (r == "OK") {
					refreshCityArray();
					changeProvince();
					alert("删除成功!");
				}
			}
		});
	}
}
function checkAll() {
	$.each($("input[name='chk_each']"), function(n, value) {
		$(value).attr("checked", !!$("#chk_all").attr("checked"));
	});
}
/**
 * 操作
 */
function operate() {
	var operateCode = $("#select_operate").val();

	// 标记主要城市
	if (operateCode == "1") {
		var cityIds = new Array();
		$.each($("input[name='chk_each']"), function(n, value) {
			if (!!$(value).attr("checked")) {
				var tr = $(value).parents("tr:first");
				var city_id = tr.find("input.txtCityId").val();
				cityIds.push(city_id);
			}
		});
		if (cityIds.length < 1) {
			alert("选择要标记的城市！");
			$("#select_operate").val("0");
			return;
		}
		var param = "cityIds=" + cityIds;
		$.ajax({
			url : 'markMainCity',
			data : param,
			type : 'post',
			success : function(r) {
				if (r == "OK") {
					refreshCityArray();
					alert("标记成功！");
					$("#select_operate").val("0");
				}
			}
		});
	}
}
/**
 * 切换省份
 */
function changeProvince() {
	var province_code = $("#select_province").val();
	var param = "provinceCode=" + province_code;
	$.ajax({
		url : "fetchCityList",
		data : param,
		success : function(data) {
			$("#city_container").html(data);
		}
	});
}
/**
 * 切换添加城市的省份
 */
function changeAddProvince() {
	var province_code = $("#select_add_province").val();
	$("#txt_city_code").val(province_code.substring(0, 2));
}