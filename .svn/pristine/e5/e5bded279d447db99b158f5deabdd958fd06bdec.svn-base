package seentao.xhsn.enterprise.info.service.impl;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.util.UUID;

import javax.servlet.ServletContext;

import org.apache.struts2.ServletActionContext;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import seentao.xhsn.bean.HsEnterpriseBO;
import seentao.xhsn.common.SeentaoApplicationContext;
import seentao.xhsn.enterprise.info.dao.IInfoDAO;
import seentao.xhsn.enterprise.info.service.IEnterpriseService;
import seentao.xhsn.tools.MD5Util;

/**
 * @author wjx
 * @date 2014年12月4日 下午3:21:49
 * @note 公司基本信息的service的实现类
 */
@Service
@Scope("prototype")
public class EnterpriseServiceImpl implements IEnterpriseService {

	@Autowired
	private IInfoDAO infoDAO;

	@Override
	public HsEnterpriseBO getByPK(String id) {
		return infoDAO.selectByPrimaryKey(id);
	}

	@Override
	@Transactional
	public void update(HsEnterpriseBO bo) {
		infoDAO.update(bo);
	}

	@Override
	public HsEnterpriseBO getBySysUserId(String id) {
		return infoDAO.getBySysUserId(id);
	}

	@Override
	public String uploadLogo(File file, String fileFileName) {
		ServletContext context = ServletActionContext.getServletContext();

		String basePath = context.getRealPath("/");
		String path = "enterpriselogo/";
		String ext = fileFileName.substring(fileFileName.lastIndexOf("."), fileFileName.length());
		String ent_id = SeentaoApplicationContext.getCurrentUser();
		path += ent_id + "/";
		String fileName = MD5Util.getMD5Str(UUID.randomUUID().toString()) + ext;
		File folder = new File(basePath + path);
		if (!folder.exists()) {
			folder.mkdirs();
		}
		File newFile = new File(folder.getAbsolutePath() + "/" + fileName);
		try {
			FileOutputStream fos = new FileOutputStream(newFile);
			FileInputStream fis = new FileInputStream(file);
			byte[] buffer = new byte[1024];
			int len = 0;
			while ((len = fis.read(buffer)) > 0) {
				fos.write(buffer, 0, len);
			}
			fos.flush();
			fos.close();
			fis.close();
		} catch (Exception e) {
			return null;
		}
		return (path + fileName);
	}
}
