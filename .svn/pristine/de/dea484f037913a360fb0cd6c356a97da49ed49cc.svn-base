package seentao.xhsn.enterprise.manageresume.action;

import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;
import java.io.UnsupportedEncodingException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.ServletContext;

import org.apache.log4j.Logger;
import org.apache.struts2.ServletActionContext;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import seentao.xhsn.bean.HsDictionaryDataBO;
import seentao.xhsn.bean.HsEnterpriseBO;
import seentao.xhsn.bean.HsInterviewInformBO;
import seentao.xhsn.bean.HsResumeBO;
import seentao.xhsn.bean.HsUserbasicinfoBO;
import seentao.xhsn.common.BaseAction;
import seentao.xhsn.common.ResourcesConstants;
import seentao.xhsn.common.SeentaoApplicationContext;
import seentao.xhsn.common.SupperBO;
import seentao.xhsn.common.UserSessionBean;
import seentao.xhsn.enterprise.info.service.IEnterpriseService;
import seentao.xhsn.enterprise.manageresume.bean.ManageResumeBean;
import seentao.xhsn.enterprise.manageresume.service.IManageResumeService;
import seentao.xhsn.exception.BusinessException;
import seentao.xhsn.person.info.service.IUBInfoService;
import seentao.xhsn.person.learnpath.dao.ILearnPathDAO;
import seentao.xhsn.person.resume.service.IResumeService;
import seentao.xhsn.sys.dictionaryfiledmap.service.IDictionaryFieldMapService;
import seentao.xhsn.tools.PropertiesUtil;

/**
 * 企业简历管理Action
 * 
 * @author niushixing 2014-12-11 下午3:10:24
 * 
 */
@Controller
@Scope(BeanDefinition.SCOPE_PROTOTYPE)
public class ManageResumeAction extends BaseAction {
	private static final long serialVersionUID = -6683655355479741724L;
	private Logger logger = Logger.getLogger(ManageResumeAction.class);
	private List<HsDictionaryDataBO> educationList;
	@Autowired
	private IDictionaryFieldMapService dfmService;
	@Autowired
	private IEnterpriseService entService;

	/**
	 * 页面初始化
	 * 
	 * @return
	 */
	public String init() {
		Map<String, List<HsDictionaryDataBO>> mapDic = dfmService.findDictDataByParam("hs_etp_releasejob");
		if (null != mapDic && mapDic.size() > 0) {
			educationList = mapDic.get("education_type");
		}

		// 初始化面试通知部分数据
		informBO = new HsInterviewInformBO();
		id = ((UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY))
				.getUser_id();
		HsEnterpriseBO entBo = entService.getByPK(id);
		informBO.setEnt_id(entBo.getId());
		informBO.setEnt_name(entBo.getEnt_name());
		informBO.setEnt_address(entBo.getCom_address());
		informBO.setInterviewer(entBo.getCom_people());
		informBO.setInterviewer_phone(entBo.getCom_telephone());
		return SUCCESS;
	}

	private static final String RESUME_TYPE_SD = "sd";
	private static final String RESUME_TYPE_GZ = "gz";
	private String target;
	private String type;
	private static final int pageSize = 7;
	private String param;
	private String id;
	@Autowired
	private IManageResumeService mrService;
	private List<ManageResumeBean> resumeList;

	/**
	 * 搜索数据
	 * 
	 * @return
	 * @throws UnsupportedEncodingException
	 */
	public String search() throws UnsupportedEncodingException {
		id = ((UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY))
				.getUser_id();
		page.setPageSize(pageSize);
		String[] params = param.split(",");
		ManageResumeBean bo = new ManageResumeBean();
		bo.setCom_id(id);
		bo.setIssee(params[0]);

		bo.setMax_edu(params[1]);
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("bo", bo);
		page.setParams(map);
		resumeList = mrService.fetchResume(page, type);
		if (type.equals(RESUME_TYPE_SD)) {
			target = "received_resume";
		} else if (type.equals(RESUME_TYPE_GZ)) {
			target = "care_resume";
		}
		return SUCCESS;
	}

	private String ids;
	private HsInterviewInformBO informBO;

	/**
	 * 发送面试通知
	 * 
	 * @return
	 */
	public String sendInforms() {
		resultStr = mrService.sendInforms(ids, informBO, type);
		return SUCCESS;
	}

	/**
	 * 企业收藏简历
	 * 
	 * @return
	 */
	public String storeResumes() {
		resultStr = mrService.restoreResume(ids, type);
		return SUCCESS;
	}

	/**
	 * 企业关注简历
	 * 
	 * @return
	 */
	public String followResumes() {
		resultStr = mrService.followResume(ids, type);
		return SUCCESS;
	}

	private String put_id;
	private String htmlPath;
	private String res_id;
	private int loginType;
	private List<SupperBO> pathlist;
	@Autowired
	private ILearnPathDAO pathDao;
	private HsResumeBO resume;
	@Autowired
	private IResumeService resumeService;
	private String id_card;
	private String user_id;

	/**
	 * 企业端预览简历
	 * 
	 * @return
	 */
	public String viewResume() {
		loginType = ((UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY))
				.getUser_type();

		// 如果是企业端登录
		// 初始化面试通知部分数据
		informBO = new HsInterviewInformBO();
		String etp_id = ((UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY))
				.getUser_id();
		HsEnterpriseBO entBo = entService.getByPK(etp_id);
		informBO.setEnt_id(entBo.getId());
		informBO.setEnt_name(entBo.getEnt_name());
		informBO.setEnt_address(entBo.getCom_address());
		informBO.setInterviewer(entBo.getCom_people());
		informBO.setInterviewer_phone(entBo.getCom_telephone());

		// 学习路径
//		HsLearnpathBO pathBo = new HsLearnpathBO();
//		pathBo.setIdentity_card(id_card);
		pathlist = pathDao.selectByUserID(user_id);
		resume = resumeService.getByPk(res_id);

		return SUCCESS;
	}

	private String filename;
    private String contentType;
    private InputStream inputStream;  
    @Autowired
	private IUBInfoService infoService;
	
	/**
	 * 简历导出
	 * @return
	 */
	public String resumeExport(){
		UserSessionBean userSessionBean = new UserSessionBean();
		HsResumeBO hsResumeBO = resumeService.getByPk(res_id);
		userSessionBean.setRes_id(res_id);
		userSessionBean.setRes_name(hsResumeBO.getName());
		HsUserbasicinfoBO userbaseBO = infoService.getByPK(user_id);
		userSessionBean.setIdentity_card(userbaseBO.getUser_idnum());
		userSessionBean.setUser_sys_id(userbaseBO.getSys_user_id());
		userSessionBean.setPhoto_url(userbaseBO.getUser_photo());
		//拼装简历数据
		List<String> htmlList=resumeService.fetchWorData(userSessionBean);
		ServletContext context = ServletActionContext.getServletContext();		
		String savePath = PropertiesUtil.getProperty(ResourcesConstants.UPLOAD_PATH);
		String user_sys_id=userSessionBean.getUser_sys_id();
		String tempPath=savePath+PropertiesUtil.getProperty("resumeexportfolder")+"/"+user_sys_id+"/";
		String docxPath=context.getRealPath("/templet/export")+"/res.docx";
		try {
			//生成word简历
			String  tempFileName=resumeService.generateWord(docxPath, tempPath, userSessionBean, htmlList);
			filename = new String((userSessionBean.getRes_name()+".docx").getBytes(), "ISO8859-1");
			contentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document";
			inputStream = new FileInputStream(new File(tempFileName));
		} catch (Exception e) {
			logger.error("生成简历失败",e);
			throw new BusinessException(e,"生成简历失败");
		}  
		 return SUCCESS;  
	}
	
	/**
	 * 取消关注简历
	 * 
	 * @return
	 */
	public String cancelFollowResume() {
		resultStr = mrService.cancelFollowResume(ids);
		return SUCCESS;
	}

	public List<HsDictionaryDataBO> getEducationList() {
		return educationList;
	}

	public void setEducationList(List<HsDictionaryDataBO> educationList) {
		this.educationList = educationList;
	}

	public String getTarget() {
		return target;
	}

	public void setTarget(String target) {
		this.target = target;
	}

	public String getType() {
		return type;
	}

	public void setType(String type) {
		this.type = type;
	}

	public String getParam() {
		return param;
	}

	public void setParam(String param) {
		this.param = param;
	}

	public List<ManageResumeBean> getResumeList() {
		return resumeList;
	}

	public void setResumeList(List<ManageResumeBean> resumeList) {
		this.resumeList = resumeList;
	}

	public HsInterviewInformBO getInformBO() {
		return informBO;
	}

	public void setInformBO(HsInterviewInformBO informBO) {
		this.informBO = informBO;
	}

	public String getIds() {
		return ids;
	}

	public void setIds(String ids) {
		this.ids = ids;
	}

	public String getId() {
		return id;
	}

	public void setId(String id) {
		this.id = id;
	}

	public String getHtmlPath() {
		return htmlPath;
	}

	public void setHtmlPath(String htmlPath) {
		this.htmlPath = htmlPath;
	}

	public String getPut_id() {
		return put_id;
	}

	public void setPut_id(String put_id) {
		this.put_id = put_id;
	}

	public String getRes_id() {
		return res_id;
	}

	public void setRes_id(String res_id) {
		this.res_id = res_id;
	}

	public int getLoginType() {
		return loginType;
	}

	public void setLoginType(int loginType) {
		this.loginType = loginType;
	}

	public List<SupperBO> getPathlist() {
		return pathlist;
	}

	public void setPathlist(List<SupperBO> pathlist) {
		this.pathlist = pathlist;
	}

	public HsResumeBO getResume() {
		return resume;
	}

	public void setResume(HsResumeBO resume) {
		this.resume = resume;
	}

	public String getId_card() {
		return id_card;
	}

	public void setId_card(String id_card) {
		this.id_card = id_card;
	}

	public String getUser_id() {
		return user_id;
	}

	public void setUser_id(String user_id) {
		this.user_id = user_id;
	}

	public String getFilename() {
		return filename;
	}

	public void setFilename(String filename) {
		this.filename = filename;
	}

	public String getContentType() {
		return contentType;
	}

	public void setContentType(String contentType) {
		this.contentType = contentType;
	}

	public InputStream getInputStream() {
		return inputStream;
	}

	public void setInputStream(InputStream inputStream) {
		this.inputStream = inputStream;
	}
	
	
	
}
