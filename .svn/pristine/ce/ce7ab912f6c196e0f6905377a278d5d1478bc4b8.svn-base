package seentao.xhsn.sys.ckeditor.service.impl;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.UUID;

import org.springframework.stereotype.Service;

import seentao.xhsn.common.ResourcesConstants;
import seentao.xhsn.sys.ckeditor.service.ICkEditorService;
import seentao.xhsn.tools.MD5Util;
import seentao.xhsn.tools.PropertiesUtil;

/**
 * ckEditor Service
 * 
 * @author niushixing 2015-1-22 10:40:59
 *
 */
@Service
public class CkEditorServiceImpl implements ICkEditorService {

	@Override
	public String uploadFile(File file, String localFileName) {
		String savePath = PropertiesUtil.getProperty(ResourcesConstants.UPLOAD_PATH);
		String path = "ckeditor/image/";
		SimpleDateFormat sf = new SimpleDateFormat("yyyy-MM-dd");
		String date = sf.format(Calendar.getInstance().getTime());
		path += date + "/";

		String ext = localFileName.substring(localFileName.lastIndexOf("."), localFileName.length());

		String serverFileName = MD5Util.getMD5Str(UUID.randomUUID().toString()) + ext;
		File folder = new File(savePath + path);
		if (!folder.exists()) {
			folder.mkdirs();
		}
		File newFile = new File(folder.getAbsolutePath() + "/" + serverFileName);
		try {
			FileOutputStream fos = new FileOutputStream(newFile);
			FileInputStream fis = new FileInputStream(file);
			byte[] buffer = new byte[1024];
			int len = 0;
			while ((len = fis.read(buffer)) > 0) {
				fos.write(buffer, 0, len);
			}
			fos.flush();
			fos.close();
			fis.close();
		} catch (Exception e) {
			return null;
		}
		return (path + serverFileName);
	}
}
