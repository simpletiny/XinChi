package seentao.xhsn.person.company.action;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.apache.commons.beanutils.PropertyUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;

import seentao.xhsn.bean.HsDictionaryDataBO;
import seentao.xhsn.bean.HsPersonLeftMenuBO;
import seentao.xhsn.bean.HsResumeBO;
import seentao.xhsn.bean.HsUbCompanyBO;
import seentao.xhsn.common.ResourcesConstants;
import seentao.xhsn.common.SeentaoApplicationContext;
import seentao.xhsn.common.SupperBO;
import seentao.xhsn.common.UserSessionBean;
import seentao.xhsn.exception.BusinessException;
import seentao.xhsn.person.company.bean.HsUbCompanyExtendBO;
import seentao.xhsn.person.company.service.IUBCompanyService;
import seentao.xhsn.person.resume.service.IResumeService;
import seentao.xhsn.sys.dictionaryfiledmap.service.IDictionaryFieldMapService;
import seentao.xhsn.sys.leftmenu.service.ILeftMenuService;


/**
 * @Description:工作经验填写和修改
 * @author 李君彦
 * @date 2014-11-24 下午3:07:41 
 * @version V1.0   
 */

@Controller
@Scope("prototype")
public class UBCompanyAction{
	private Logger logger=Logger.getLogger(UBCompanyAction.class);
	
	
	private HsUbCompanyExtendBO paramBO;
	
	private List<HsUbCompanyExtendBO> boList;
	//是否继续新增
	private String isAdd;
	/**
	 * 当前左侧选中的菜单id
	 */
	private String lm_tab_name;
		
	/**
	 * 左侧菜单的集合
	 */
	private List<HsPersonLeftMenuBO> leftmenus;
		
	/**
	 * 简历完成度
	 */
	private String res_completeness;
	
		@Autowired
	private ILeftMenuService lmService;
	@Autowired
	private IUBCompanyService uBCompanyService;
	@Autowired
	private IDictionaryFieldMapService dictFieldMapService;
	
	private Map<String, List<HsDictionaryDataBO>> dicts;
	
	@Autowired
	private IResumeService resumeService;
	/**
	 * 新增
	 * @return
	 */
	public String saveUBCompany(){
		UserSessionBean bean = (UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY);
		paramBO.setRes_id(bean.getRes_id());
		paramBO.setUser_id(bean.getUser_sys_id());
		HsUbCompanyBO companyBO = new HsUbCompanyBO();
		this.copyProperties(companyBO, paramBO);
		if(StringUtils.isNotEmpty(paramBO.getId()))
			uBCompanyService.update(companyBO);
		else
			uBCompanyService.insert(companyBO);
		
		HsResumeBO resBo = resumeService.getByPk(bean.getRes_id());
		resumeService.generatePractice(resBo);
		return "SUCCESS";
	}
	
	public String updateUBCompany(){
		uBCompanyService.update(paramBO);
		UserSessionBean bean = (UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY);
		HsResumeBO resBo = resumeService.getByPk(bean.getRes_id());
		resumeService.generatePractice(resBo);
		return "SUCCESS";
	}
	
	public String delUBCompany(){
		uBCompanyService.delCompany(paramBO.getId());
		UserSessionBean bean = (UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY);
		HsResumeBO resBo = resumeService.getByPk(bean.getRes_id());
		resumeService.generatePractice(resBo);
		return "SUCCESS";
	}
	
	public String findUBCompany(){
		HsUbCompanyBO companyBO = uBCompanyService.selectByPrimaryKey(paramBO.getId());
		dicts = dictFieldMapService.findDictDataByParam(paramBO.getTable_name());
		this.copyProperties(paramBO,companyBO); 
		//职位月薪
		if(StringUtils.isNotEmpty(companyBO.getSalary_scope())){
			Map<String, String> salary_scope = dictFieldMapService.getDictValueByParam(companyBO.getTable_name(), "salary_scope", companyBO.getSalary_scope());
			paramBO.setSalary_scope_value(salary_scope.get("value"));
		}
		//企业规模
		if(StringUtils.isNotEmpty(companyBO.getCom_size())){
			Map<String, String> com_size = dictFieldMapService.getDictValueByParam(companyBO.getTable_name(), "com_size", companyBO.getCom_size());
			paramBO.setCom_size_value(com_size.get("value"));
		}
		//企业性质
		if(StringUtils.isNotEmpty(companyBO.getCom_type())){
			Map<String, String> com_type = dictFieldMapService.getDictValueByParam(companyBO.getTable_name(), "com_type", companyBO.getCom_type());
			paramBO.setCom_type_value(com_type.get("value"));
		}
		return "SUCCESS";
	}
	
	public String findAllUBCompany(){
		HsUbCompanyBO paramBO=new HsUbCompanyBO();
		UserSessionBean sessionBean = (UserSessionBean) SeentaoApplicationContext.getSession(ResourcesConstants.LOGIN_SESSION_KEY);
		paramBO.setRes_id(sessionBean.getRes_id());
		paramBO.setUser_id(sessionBean.getUser_sys_id());
		List<HsUbCompanyBO> list = uBCompanyService.getAllByParam(paramBO);
		dicts = dictFieldMapService.findDictDataByParam(paramBO.getTable_name());
		HsUbCompanyExtendBO extendBO =null;
		boList=new ArrayList<HsUbCompanyExtendBO>();
		for(HsUbCompanyBO companyBO:list){
			extendBO=new HsUbCompanyExtendBO();
			this.copyProperties(extendBO, companyBO);
			//职位月薪
			if(StringUtils.isNotEmpty(companyBO.getSalary_scope())){
				Map<String, String> salary_scope = dictFieldMapService.getDictValueByParam(companyBO.getTable_name(), "salary_scope", companyBO.getSalary_scope());
				extendBO.setSalary_scope_value(salary_scope.get("value"));
			}
			//企业规模
			if(StringUtils.isNotEmpty(companyBO.getCom_size())){
				Map<String, String> com_size = dictFieldMapService.getDictValueByParam(companyBO.getTable_name(), "com_size", companyBO.getCom_size());
				extendBO.setCom_size_value(com_size.get("value"));
			}
			//企业性质
			if(StringUtils.isNotEmpty(companyBO.getCom_type())){
				Map<String, String> com_type = dictFieldMapService.getDictValueByParam(companyBO.getTable_name(), "com_type", companyBO.getCom_type());
				extendBO.setCom_type_value(com_type.get("value"));
			}
			boList.add(extendBO);
		}
		isAdd=isAdd==null?"n":isAdd;
		leftmenus = lmService.findLeftMenuByParams();
		// 获取简历完成度
		res_completeness = lmService.getCompletenessByPK();
		return "SUCCESS";
	}
	/**
	 * 表单验证
	 */
	public void validateAddUBCompany(){
		
	}

	private void copyProperties(SupperBO dest, SupperBO src) {
		try {
			PropertyUtils.copyProperties(dest, src);
		} catch (Exception e) {
			logger.error("属性值拷贝失败",e);
			throw new BusinessException(e);
		}
	}
	
	public HsUbCompanyExtendBO getBo() {
		return paramBO;
	}

	public void setBo(HsUbCompanyExtendBO bo) {
		this.paramBO = bo;
	}

	public List<HsUbCompanyExtendBO> getBoList() {
		return boList;
	}

	public void setBoList(List<HsUbCompanyExtendBO> boList) {
		this.boList = boList;
	}

	public String getIsAdd() {
		return isAdd;
	}

	public void setIsAdd(String isAdd) {
		this.isAdd = isAdd;
	}

	public Map<String, List<HsDictionaryDataBO>> getDicts() {
		return dicts;
	}

	public void setDicts(Map<String, List<HsDictionaryDataBO>> dicts) {
		this.dicts = dicts;
	}
	
	public String getLm_tab_name() {
		return lm_tab_name;
	}

	public void setLm_tab_name(String lm_id) {
		this.lm_tab_name = lm_id;
	}

	public List<HsPersonLeftMenuBO> getLeftmenus() {
		return leftmenus;
	}

	public void setLeftmenus(List<HsPersonLeftMenuBO> leftmenus) {
		this.leftmenus = leftmenus;
	}

	public String getRes_completeness() {
		return res_completeness;
	}

	public void setRes_completeness(String res_completeness) {
		this.res_completeness = res_completeness;
	}
	
}