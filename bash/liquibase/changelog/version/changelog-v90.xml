<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<changeSet id="1" author="simpletiny">
		<sql>
            <![CDATA[
            		ALTER TABLE deposit_ticket_paid 
						ADD COLUMN type VARCHAR(10) NULL COMMENT '支付类型' AFTER money;
             ]]>
			<comment>ALTER TABLE deposit_ticket_paid</comment>
		</sql>
	</changeSet>
	<changeSet id="2" author="simpletiny">
		<sql>
            <![CDATA[
            		CREATE VIEW view_discount_receivable AS
						SELECT 
						    A.team_number AS team_number,
						    A.create_user AS user_number,
						    D.final_type,
						    A.confirm_date AS confirm_date,
							IF(B.final_flg='Y',B.final_receivable,B.budget_receivable) as receivable,
						    C.status,
						    SUM(C.received) AS discount_received,
						    IF(B.final_flg='Y',B.final_balance,B.budget_balance) as balance,
						    DATE_FORMAT(FROM_UNIXTIME( B.update_time/1000),'%Y-%m-%d') AS update_time
						FROM
						    budget_order_view A
						        LEFT JOIN
						    final_order_view D ON A.team_number = D.team_number
						        LEFT JOIN
						    receivable B ON A.team_number = B.team_number
						        LEFT JOIN
						    client_received_detail C ON A.team_number = C.team_number
						        AND LEFT(C.received_time, 10) <= (A.confirm_date + INTERVAL 1 DAY)
						        AND C.status = 'E'
						        AND C.type != 'TAIL98'
						WHERE
						    C.team_number IS NOT NULL AND (D.final_type is null OR D.final_type!=4)
						GROUP BY A.team_number
						HAVING balance=0 AND discount_received>=receivable*0.98 and receivable >=discount_received;
             ]]>
			<comment>CREATE VIEW view_discount_receivable</comment>
		</sql>
	</changeSet>
	<changeSet id="3" author="simpletiny">
		<sql>
            <![CDATA[
            		ALTER TABLE air_ticket_need 
						CHANGE COLUMN product_name product_name VARCHAR(20) NOT NULL ;
             ]]>
			<comment>ALTER TABLE air_ticket_need </comment>
		</sql>
	</changeSet>
	<changeSet id="4" author="simpletiny">
		<sql>
            <![CDATA[
            		ALTER TABLE supplier_paid_detail
					ADD COLUMN payable_pk CHAR(22) NULL COMMENT '关联的应付款pk' AFTER paid_user;
             ]]>
			<comment>ALTER TABLE supplier_paid_detail</comment>
		</sql>
	</changeSet>
	<changeSet id="5" author="simpletiny">
		<sql>
            <![CDATA[
            		ALTER TABLE budget_non_standard_order 
					CHANGE COLUMN independent_flg independent_flg CHAR(1) NULL DEFAULT 'N' COMMENT '是否为独立团，Y独立团，N非独立，A单机票';
             ]]>
			<comment>ALTER TABLE budget_non_standard_order</comment>
		</sql>
	</changeSet>
	<changeSet id="6" author="simpletiny">
		<sql>
            <![CDATA[
            		CREATE TABLE sale_order_ticket_info (
					  create_user VARCHAR(10) NULL DEFAULT NULL,
					  update_user VARCHAR(10) NULL DEFAULT NULL,
					  create_time VARCHAR(15) NULL DEFAULT NULL,
					  update_time VARCHAR(15) NULL DEFAULT NULL,
					  pk CHAR(22) NOT NULL,
					  team_number VARCHAR(10) NULL,
					  ticket_index TINYINT NULL,
					  ticket_date VARCHAR(10) NULL,
					  from_city VARCHAR(10) NULL,
					  to_city VARCHAR(10) NULL,
					  order_pk CHAR(22) NULL,
					  comment VARCHAR(200) NULL COMMENT '票务需求，有多条记录的数据，只存储于ticket_index为1的行',
					  PRIMARY KEY (pk))
					ENGINE = InnoDB
					DEFAULT CHARACTER SET = utf8
					COLLATE = utf8_bin
					COMMENT = '订单机票信息（目前用于单机票）';
             ]]>
			<comment>CREATE TABLE sale_order_ticket_info</comment>
		</sql>
	</changeSet>
	<changeSet id="7" author="simpletiny">
		<sql>
            <![CDATA[
            	DROP VIEW IF EXISTS view_order_count;
				CREATE VIEW view_order_count AS
				    SELECT 
				        A.client_employee_pk AS client_employee_pk,
				        COUNT(A.pk) AS order_count,
				        COUNT(IF(A.departure_date >= DATE_FORMAT(DATE_ADD(NOW(), INTERVAL - 20 DAY),
				                    '%Y-%m-%d'),
				            1,
				            NULL)) AS day21_count,
				        MAX(A.departure_date) AS last_confirm_date,
				        MIN(if(A.departure_date is null or A.departure_date = '','2099-01-01',A.departure_date)) AS first_confirm_date
				    FROM
				        budget_order_view A
				            LEFT JOIN
				        client_employee B ON A.client_employee_pk = B.pk
				        where B.pk is not null
				    GROUP BY A.client_employee_pk;
             ]]>
			<comment>ALTER VIEW view_order_count</comment>
		</sql>
	</changeSet>
	<changeSet id="8" author="simpletiny">
		<sql>
            <![CDATA[
            	ALTER TABLE supplier_paid_detail 
				ADD COLUMN voucher_file VARCHAR(30) NULL COMMENT '当类型为back即收入时的收入凭证文件' AFTER payable_pk,
				ADD COLUMN voucher_number VARCHAR(20) NULL DEFAULT NULL COMMENT '当类型为back即收入时的收入匹配之后与银行流水之间的凭证号' AFTER voucher_file;
             ]]>
			<comment>ALTER TABLE supplier_paid_detail</comment>
		</sql>
	</changeSet>
	<changeSet id="9" author="simpletiny">
		<sql>
            <![CDATA[
            	DROP VIEW if exists paid_detail;
          		CREATE VIEW paid_detail AS 
				SELECT * FROM supplier_paid_detail WHERE type like '%STRIKE%'
				union all
				SELECT * FROM supplier_paid_detail WHERE type not like '%STRIKE%' 
				GROUP BY related_pk
             ]]>
			<comment> ALTER VIEW paid_detail</comment>
		</sql>
	</changeSet>
	<changeSet id="10" author="simpletiny">
		<sql>
            <![CDATA[
            	ALTER TABLE air_ticket_paid_detail 
					ADD COLUMN card_account VARCHAR(50) NULL COMMENT '当type是BACK即收入时， 所记录的收入账户' AFTER receiver,
					ADD COLUMN voucher_file VARCHAR(30) NULL COMMENT '当为退返时的收入凭证' AFTER card_account;
             ]]>
			<comment>ALTER TABLE air_ticket_paid_detail </comment>
		</sql>
	</changeSet>
	<changeSet id="11" author="simpletiny">
		<sql>
            <![CDATA[
            	DROP VIEW if exists view_air_ticket_paid_detail;
          		CREATE VIEW view_air_ticket_paid_detail AS 
				SELECT * FROM air_ticket_paid_detail WHERE type LIKE '%STRIKE%'
				union all
				SELECT * FROM air_ticket_paid_detail WHERE type NOT LIKE '%STRIKE%' 
				GROUP BY related_pk
             ]]>
			<comment>ALTER VIEW view_air_ticket_paid_detail</comment>
		</sql>
	</changeSet>
	<changeSet id="12" author="simpletiny">
		<sql>
            <![CDATA[
            	CREATE VIEW view_all_need_match_received AS
				    SELECT 
				        IF(A.type = 'SUM',
				            A.sum_received,
				            A.received) AS received,
				        A.type AS type,
				        A.received_time,
				        A.card_account,
				        A.related_pk,
				        A.create_user AS apply_user,
				        DATE_FORMAT(FROM_UNIXTIME(A.create_time / 1000),
				                '%Y-%m-%d') AS apply_date,
				        B.name AS pay_user,
				        A.client_employee_pk AS pay_user_pk,
				        'C' AS from_where
				    FROM
				        received_detail A
				            LEFT JOIN
				        client_employee B ON A.client_employee_pk = B.pk
				    WHERE
				        A.type IN ('SUM' , 'RECEIVED')
				            AND A.status = 'I' 
				    UNION ALL SELECT 
				        A.allot_money AS received,
				        'BACK' AS type,
				        A.time AS received_time,
				        A.card_account,
				        A.related_pk,
				        A.create_user AS apply_user,
				        DATE_FORMAT(FROM_UNIXTIME(A.create_time / 1000),
				                '%Y-%m-%d') AS apply_date,
				        B.name AS pay_user,
				        A.supplier_employee_pk AS pay_user_pk,
				        'D' AS from_where
				    FROM
				        paid_detail A
				            LEFT JOIN
				        supplier_employee B ON A.supplier_employee_pk = B.pk
				    WHERE
				        A.type = 'BACK' AND A.status = 'I' 
				    UNION ALL SELECT 
				        A.allot_money AS received,
				        A.type AS type,
				        A.time AS received_time,
				        A.card_account,
				        A.related_pk,
				        A.create_user AS apply_user,
				        DATE_FORMAT(FROM_UNIXTIME(A.create_time / 1000),
				                '%Y-%m-%d') AS apply_date,
				        B.name AS pay_user,
				        A.supplier_employee_pk AS pay_user_pk,
				        'A' AS from_where
				    FROM
				        view_air_ticket_paid_detail A
				            LEFT JOIN
				        supplier_employee B ON A.supplier_employee_pk = B.pk
				    WHERE
				        A.type in('BACK','RECEIVE') AND A.status = 'I';
             ]]>
			<comment>CREATE VIEW view_all_need_match_received </comment>
		</sql>
	</changeSet>
	<changeSet id="13" author="simpletiny">
		<sql>
            <![CDATA[
            	ALTER TABLE received_match 
					ADD COLUMN from_where CHAR(1) NULL COMMENT '收入来源，A，票务退返，C，客户收入，D，地接退返' AFTER create_time;
             ]]>
			<comment>ALTER TABLE received_match</comment>
		</sql>
	</changeSet>
</databaseChangeLog>




