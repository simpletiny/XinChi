<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<changeSet id="1" author="simpletiny">
		<sql>
            <![CDATA[
            		ALTER TABLE air_ticket_change_log 
					ADD COLUMN captain VARCHAR(10) NULL AFTER update_user,
					ADD COLUMN from_to_city VARCHAR(22) NULL AFTER captain,
					ADD COLUMN first_date VARCHAR(10) NULL AFTER from_to_city;
             ]]>
			<comment>ALTER TABLE air_ticket_change_log</comment>
		</sql>
	</changeSet>
	<changeSet id="2" author="simpletiny">
		<sql>
            <![CDATA[
            	ALTER TABLE air_ticket_paid_detail 
					ADD INDEX base_pk (base_pk ASC);
             ]]>
			<comment>ALTER TABLE air_ticket_paid_detail </comment>
		</sql>
	</changeSet>
	<changeSet id="3" author="simpletiny">
		<sql>
            <![CDATA[
            	ALTER TABLE budget_standard_order 
            	ADD COLUMN do_confirm_date VARCHAR(10) NULL COMMENT '销售执行确认的日期。' AFTER cancel_flg,
            	CHANGE COLUMN operate_flg operate_flg VARCHAR(5) NULL DEFAULT 'N,N' COMMENT '操作状态，前者为产品(N,A,P,I)，后者为票务(N,P,I,Y)。' ,
				CHANGE COLUMN lock_flg lock_flg VARCHAR(5) NULL DEFAULT 'N,N' COMMENT '锁定标识,前者产品锁定,后者票务锁定.' ;
				ALTER TABLE budget_non_standard_order 
				ADD COLUMN do_confirm_date VARCHAR(10) NULL COMMENT '销售执行确认的日期。' AFTER cancel_flg,
				CHANGE COLUMN operate_flg operate_flg VARCHAR(5) NULL DEFAULT 'N,N' COMMENT '操作状态，前者为产品(N,A,P,I)，后者为票务(N,P,I,Y)。' ,
				CHANGE COLUMN lock_flg lock_flg VARCHAR(5) NULL DEFAULT 'N,N' COMMENT '锁定标识,前者产品锁定,后者票务锁定.' ;
				ALTER TABLE final_standard_order 
            	CHANGE COLUMN operate_flg operate_flg VARCHAR(5) NULL DEFAULT 'N,N' COMMENT '操作状态，前者为产品(N,A,P,I)，后者为票务(N,P,I,Y)。';
				ALTER TABLE final_non_standard_order
            	CHANGE COLUMN operate_flg operate_flg VARCHAR(5) NULL DEFAULT 'N,N' COMMENT '操作状态，前者为产品(N,A,P,I)，后者为票务(N,P,I,Y)。';
				ALTER TABLE sale_order_name_list 
				ADD COLUMN lock_flg VARCHAR(5) NULL DEFAULT 'N,N' COMMENT '锁定标识：N,Y,前者代表产品的锁定，后者代表票务的锁定。' AFTER ticket_price,
				ADD COLUMN delete_flg CHAR(1) NULL DEFAULT 'N' COMMENT '删除标识。' AFTER lock_flg;
				ALTER TABLE air_ticket_name_list 
				ADD COLUMN lock_flg CHAR(1) NULL DEFAULT 'N' COMMENT '锁定标识' AFTER chairman,
				ADD COLUMN delete_flg CHAR(1) NULL DEFAULT 'N' COMMENT '删除标识。' AFTER lock_flg,
				ADD COLUMN base_pk CHAR(22) NULL COMMENT '销售名单pk' AFTER delete_flg;
             ]]>
			<comment>ALTER TABLE budget_standard_order,budget_non_standard_order,final_standard_order,final_non_standard_order,sale_order_name_list,air_ticket_name_list</comment>
		</sql>
	</changeSet>
	<changeSet id="4" author="simpletiny">
		<sql>
            <![CDATA[
            	DROP VIEW IF EXISTS budget_order_view;
				CREATE VIEW budget_order_view AS
					select  A.team_number, 
					    	A.product_name,
							'' as product_pk,
					    	A.client_employee_pk, 
					    	C.name AS client_employee_name,
					    	A.independent_flg, 
					    	A.comment, 
					    	A.other_cost_comment, 
					    	A.other_cost, 
					    	A.fy, 
					    	A.special_cost, 
					    	A.special_count, 
					    	A.adult_cost, 
					    	A.adult_count, 
					    	A.receivable, 
					    	A.days, 
					    	A.departure_date, 
					    	A.pk, 
					    	A.update_user,
					    	A.create_user AS create_user_number,
					    	B.user_name AS create_user,
					    	A.confirm_flg, 
					    	A.create_time,
					    	A.update_time,
					    	A.confirm_date,
					    	A.confirm_file,
					    	'N' AS standard_flg,
					    	A.product_manager AS product_manager_number,
					    	D.user_name AS product_manager,
					    	A.air_ticket_cost,
					    	A.product_cost,
					    	A.operate_flg,
					    	A.name_list,
                            A.lock_flg,
                            A.cancel_flg,
                            A.name_confirm_status,
                            A.passenger_captain,
                            '' AS receivable_comment,
                            '' AS treat_comment,
                            '' AS client_name,
                            case when
							A.departure_date>now() then 'no'
							when now()>=A.departure_date and
							DATE_ADD(A.departure_date,interval A.days-1 day) >
							now()
							then 'yes'
							when now()>=DATE_ADD(A.departure_date,interval A.days-1 day) then 'back'
							end
							AS status,
							0 AS product_value,
							A.receivable_first_flg,
							A.do_confirm_date
					from budget_non_standard_order A LEFT JOIN user_base B ON A.create_user = B.user_number
					LEFT JOIN client_employee C ON A.client_employee_pk = C.pk
					LEFT JOIN user_base D ON A.product_manager = D.user_number
					union all 
					select  A.team_number, 
					    	IFNULL(A.product_name,C.name) AS product_name,
							A.product_pk,
					    	A.client_employee_pk,
					    	D.name AS client_employee_name,
					    	A.independent_flg, 
					    	A.comment, 
					    	A.other_cost_comment, 
					    	A.other_cost, 
					    	A.fy, 
					    	A.special_cost, 
					    	A.special_count, 
					    	A.adult_cost, 
					    	A.adult_count, 
					    	A.receivable, 
					    	A.days, 
					    	A.departure_date, 
					    	A.pk, 
					    	A.update_user, 
					    	A.create_user AS create_user_number, 
					    	B.user_name AS create_user,
					    	A.confirm_flg, 
					    	A.create_time,
					    	A.update_time,
					    	A.confirm_date,
					    	A.confirm_file,
					    	'Y' AS standard_flg,
					    	C.product_manager AS product_manager_number,
					    	E.user_name AS product_manager,
					    	A.air_ticket_cost,
					    	A.product_cost,
					    	A.operate_flg,
					    	A.name_list,
                            A.lock_flg,
                            A.cancel_flg,
                            A.name_confirm_status,
                            A.passenger_captain,
                            A.receivable_comment,
                            A.treat_comment,
                            F.client_short_name AS client_name,
                            case when
							A.departure_date>now() then 'no'
							when now()>=A.departure_date and
							DATE_ADD(A.departure_date,interval A.days-1 day) >
							now()
							then 'yes'
							when now()>=DATE_ADD(A.departure_date,interval A.days-1 day) then 'back'
							end
							AS status,
							A.product_value,
							A.receivable_first_flg,
							A.do_confirm_date
					from budget_standard_order A LEFT JOIN user_base B ON A.create_user = B.user_number
					LEFT JOIN product C ON A.product_pk = C.pk
					LEFT JOIN client_employee D ON A.client_employee_pk = D.pk
       				LEFT JOIN user_base E ON C.product_manager = E.user_number
       				LEFT JOIN client F ON D.financial_body_pk = F.pk;

             ]]>
			<comment>ALTER VIEW budget_order_view </comment>
		</sql>
	</changeSet>
	<changeSet id="5" author="simpletiny">
		<sql>
            <![CDATA[
				ALTER TABLE air_ticket_name_list 
					ADD COLUMN change_cost DECIMAL(12,2) NULL DEFAULT 0 COMMENT '航变费用' AFTER base_pk;
	          ]]>
			<comment>ALTER TABLE air_ticket_name_list</comment>
		</sql>
	</changeSet>
</databaseChangeLog>




